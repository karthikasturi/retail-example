name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

  # build:
  #   runs-on: ubuntu-latest
  #   needs: setup
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #     - name: Build backend (lint, format)
  #       run: |
  #         pip install black ruff
  #         black --check backend/
  #         ruff backend/

  unittest:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install -r backend/requirements.txt
          pip install pytest pytest-asyncio pytest-cov
      - name: Run unit tests
        run: |
          pytest --cov=backend/app --cov-report=xml --cov-report=term-missing
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml

  build-docker:
    runs-on: ubuntu-latest
    needs: unittest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build Docker image
        run: |
          cd backend
          docker build -f Dockerfile -t retail-backend:ci-latest .

  trivy-scan:
    runs-on: ubuntu-latest
    needs: build-docker
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install Trivy
        uses: aquasecurity/trivy-action@0.33.1
      - name: Scan Docker image with Trivy
        run: |
          trivy image --format sarif --output trivy-report.sarif retail-backend:ci-latest
      - name: Upload Trivy scan report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-report.sarif

  publish-report:
    runs-on: ubuntu-latest
    needs: trivy-scan
    steps:
      - name: Download coverage report
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
      - name: Download Trivy report
        uses: actions/download-artifact@v4
        with:
          name: trivy-report
      - name: Publish reports
        run: |
          echo "Coverage and Trivy reports are available as workflow artifacts."
